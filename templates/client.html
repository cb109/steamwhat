<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>steamwhat</title>
  </head>
  <link href="https://fonts.googleapis.com/css?family=Encode+Sans+Condensed"
        rel="stylesheet">
  <body>
    <div id="app">
      <div class="container">
        <div class="inputs">
          <h3>
            <a href="http://github.com/cb109/steamwhat">
              Steam what?
            </a>
          </h3>
          <div class="legend">
            You want to play a game on Steam with one or more of your
            friends, but you don't know which?
            <p />
            Add Steam IDs (one per line) below and see which games you
            all share.
            <p />
            <small>
              <a href="https://steamcommunity.com/sharedfiles/filedetails/?id=209000244">
                But I don't know my Steam ID, where to find it?
              </a>
            </small>
            <p />
          </div>
          <textarea id="steamids" rows="5"></textarea>
          <button id="find-btn"
                  onclick="api.onFindSharedGamesClicked()">
            Find shared Games
          </button>
          <div id="warning" hidden>
            Something went wrong, please check your input and try again
          </div>
        </div>
        <div class="loader" hidden></div>
        <div id="results"></div>
      </div>
    </div>
    <script>
      var api = (function() {
        'use strict';

        // From: https://stackoverflow.com/questions/247483
        var HttpClient = function() {
          this.get = function(url, successCallback, failureCallback) {
            var request = new XMLHttpRequest();
            request.onreadystatechange = function() {
              if (request.readyState == 4) {
                if (request.status == 200) {
                  successCallback(request.responseText);
                } else {
                  failureCallback(request.responseText);
                }
              }
            }
            request.open('GET', url, true);
            request.send(null);
          }
        }

        function getSteamIdsTextArea() {
          return document.querySelector('textarea#steamids');
        }

        function getSteamIds() {
          var area = getSteamIdsTextArea();
          var text = area.value;
          var tokens = text.split('\n');
          tokens = tokens.map(function(token) {
            return token.trim();
          });
          tokens = tokens.filter(function(token) {
            return token !== '';
          });
          return tokens;
        }

        function loadSteamIds() {
          var steamIds = localStorage.getItem('steamwhat__steamIds');
          if (!steamIds) {
            return null;
          }
          var steamIds = steamIds.split(',');
          return steamIds;
        }

        function storeSteamIds(steamIds) {
          var value = JSON.stringify(steamIds);
          localStorage.setItem('steamwhat__steamIds', steamIds);
        }

        function useInitialSteamIds(steamIds) {
          var area = getSteamIdsTextArea();
          var text = steamIds.join('\n');
          area.innerHTML = text;
        }

        function showWarning() {
          var el = document.querySelector('#warning');
          el.hidden = false;
          setTimeout(function() {
            el.hidden = true;
          }, 3000)
        }

        function getButtonElement() {
          return document.querySelector('#find-btn');
        }

        function enableButton(value) {
          getButtonElement().disabled = !value;
        }

        function getLoaderElement() {
          return document.querySelector('.loader');
        }

        function showLoader(value) {
          getLoaderElement().hidden = !value;
        }

        function getResultsElement() {
          var el = document.querySelector('#results');
          return el;
        }

        function flushResults() {
          var el = getResultsElement();
          el.innerHTML = '';
        }

        function reportResults(response) {
          var data = JSON.parse(response);
          var results = getResultsElement();

          // Players
          var h4 = document.createElement('h4');
          h4.innerHTML = 'Players';
          var ul = document.createElement('ul');
          for (var i = 0; i < data.players.length; i++) {
            var player = data.players[i];
            var li = document.createElement('li');
            li.innerHTML = player.name + ' - ' + player.steamid;
            ul.appendChild(li);
          }
          results.appendChild(h4);
          results.appendChild(ul);

          // Shared Games
          var h4 = document.createElement('h4');
          h4.innerHTML = 'Shared Games';
          var ul = document.createElement('ul');
          for (var i = 0; i < data.shared_games.length; i++) {
            var game = data.shared_games[i];
            var li = document.createElement('li');
            var a = document.createElement('a');
            var txt = document.createTextNode(game.name);
            a.appendChild(txt);
            a.href = 'http://store.steampowered.com/app/' + game.appid;
            a.target = '_blank';
            li.appendChild(a);
            ul.appendChild(li);
          }
          results.appendChild(h4);
          results.appendChild(ul);
        }

        function onFindSharedGamesClicked() {
          var steamIds = getSteamIds();
          if (!steamIds.length) {
            alert('You must enter at least one Steam ID');
            return;
          }

          var steamIdsParam = steamIds.join(',');
          var query = '?steamids=' + encodeURI(steamIdsParam);
          var url = '/sharedgames' + query;

          var client = new HttpClient();
          flushResults();

          enableButton(false);
          showLoader(true);

          client.get(url,
            function(response) {
              enableButton(true);
              showLoader(false);

              reportResults(response);
              storeSteamIds(steamIds);
            },
            function(error) {
              console.error(error);
              enableButton(true);
              showLoader(false);

              showWarning();
              flushResults();
            });
        }

        // Try to get steamIds from localStorage to begin with.
        var recentSteamIds = loadSteamIds();
        if (recentSteamIds) {
          useInitialSteamIds(recentSteamIds);
        }

        return {
          onFindSharedGamesClicked: onFindSharedGamesClicked,
        };
      })();
    </script>
    <style>
      * {
        font-family: 'Encode Sans Condensed', sans-serif;
      }

      textarea {
        resize: vertical;
      }

      #app {
        display: flex;
      }

      a {
        text-decoration: none
      }

      .container {
        display: flex;
        flex-direction: column;
        width: 100%;
        justify-content: center;
        align-items: center;
        margin: .5em 1em 0 1em;
      }

      .legend {
        color: grey;
      }

      .inputs {
        display: flex;
        flex-direction: column;
        max-width: 480px;
        flex-grow: 1;
      }

      .inputs textarea {
        margin-top: .5em;
        width: calc(100% - .5em);
      }

      .inputs button {
        margin-top: .5em;
        margin-left: auto;
        height: 3em;
      }

      .inputs #warning {
        margin-top: 1em;
        margin-bottom: 1em;
        padding: 1em;
        background-color: #FFE0BA;
      }

      #results {
        width: 100%;
        max-width: 480px;
      }

      /** CSS Progress Loader from https://projects.lukehaas.me/css-loaders */
      .loader,
      .loader:before,
      .loader:after {
        border-radius: 50%;
        width: 2.5em;
        height: 2.5em;
        -webkit-animation-fill-mode: both;
        animation-fill-mode: both;
        -webkit-animation: load7 1.8s infinite ease-in-out;
        animation: load7 1.8s infinite ease-in-out;
      }
      .loader {
        color: #e0e0e0;
        font-size: 10px;
        margin: 80px auto;
        position: relative;
        text-indent: -9999em;
        -webkit-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-animation-delay: -0.16s;
        animation-delay: -0.16s;
      }
      .loader:before,
      .loader:after {
        content: '';
        position: absolute;
        top: 0;
      }
      .loader:before {
        left: -3.5em;
        -webkit-animation-delay: -0.32s;
        animation-delay: -0.32s;
      }
      .loader:after {
        left: 3.5em;
      }
      @-webkit-keyframes load7 {
        0%,
        80%,
        100% {
          box-shadow: 0 2.5em 0 -1.3em;
        }
        40% {
          box-shadow: 0 2.5em 0 0;
        }
      }
      @keyframes load7 {
        0%,
        80%,
        100% {
          box-shadow: 0 2.5em 0 -1.3em;
        }
        40% {
          box-shadow: 0 2.5em 0 0;
        }
      }
    </style>
  </body>
</html>